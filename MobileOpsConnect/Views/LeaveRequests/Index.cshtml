@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager
@model IEnumerable<MobileOpsConnect.Models.LeaveRequest>

@{
    ViewData["Title"] = "Leave Request Management";

    // 1. Get Current User Info
    var currentUser = await UserManager.GetUserAsync(User);
    var currentUserId = currentUser?.Id;

    // 2. Determine MY Rank (The Viewer)
    int myRank = 0;
    if (User.IsInRole("SuperAdmin")) { myRank = 4; }
    else if (User.IsInRole("SystemAdmin")) { myRank = 3; }
    else if (User.IsInRole("DepartmentManager")) { myRank = 2; }
    else { myRank = 1; } // Employee/Staff

    bool hasPower = myRank > 1;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>
        @if (hasPower)
        {
            <text>Manage Leave Requests</text>
        }
        else
        {
            <text>My Leave History</text>
        }
    </h1>

    @if (!hasPower)
    {
        <a asp-action="Create" class="btn btn-primary">➕ Apply for New Leave</a>
    }
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Employee</th>
                    <th>Type</th>
                    <th>Dates</th>
                    <th>Reason</th>
                    <th>Status</th>
                    <th>Requested On</th>
                    @if (hasPower)
                    {
                        <th>Actions</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    // --- LOGIC BLOCK FOR EACH ROW ---
                    bool isMyRequest = (item.UserID == currentUserId);

                    // Get the Requestor's Role to determine THEIR Rank
                    // Note: In a real app, we'd pass this via ViewModel to avoid loops,
                    // but for Capstone, this direct lookup is acceptable.
                    var requestorRoles = await UserManager.GetRolesAsync(item.User);
                    string rRole = requestorRoles.FirstOrDefault() ?? "Employee";

                    int targetRank = 1; // Default to Employee
                    if (rRole == "SuperAdmin") { targetRank = 4; }
                    else if (rRole == "SystemAdmin") { targetRank = 3; }
                    else if (rRole == "DepartmentManager") { targetRank = 2; }

                    // DECISION: Can I approve this specific person?
                    // Rule 1: I must be higher rank than them.
                    // Rule 2: Exception - If I am SuperAdmin (Rank 4), I can approve myself (Rank 4).
                    bool canApproveThisRow = (myRank > targetRank) || (myRank == 4 && isMyRequest);
                    // -------------------------------

                    <tr>
                        <td class="fw-bold">
                            @if (item.User != null)
                            {
                                @item.User.UserName
                            }
                            else
                            {
                                <span class="text-muted">Unknown</span>
                            }

                            @if (isMyRequest)
                            {
                                <span class="badge bg-secondary ms-2">YOU</span>
                            }

                            <small class="text-muted d-block" style="font-size: 0.7em;">@rRole</small>
                        </td>
                        <td>@item.LeaveType</td>
                        <td>
                            @item.StartDate.ToString("MMM dd") - @item.EndDate.ToString("MMM dd")
                            <br />
                            <small class="text-muted">(@((item.EndDate - item.StartDate).Days + 1) Days)</small>
                        </td>
                        <td>@item.Reason</td>
                        <td>
                            @if (item.Status == "Pending")
                            {
                                <span class="badge bg-warning text-dark">Pending</span>
                            }
                            else if (item.Status == "Approved")
                            {
                                <span class="badge bg-success">Approved</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Rejected</span>
                            }
                        </td>
                        <td>@item.DateRequested.ToString("MMM dd, yyyy")</td>

                        @if (hasPower)
                        {
                            <td>
                                @if (item.Status == "Pending")
                                {
                                    @if (canApproveThisRow)
                                    {
                                        <div class="btn-group" role="group">
                                            <a asp-action="Approve" asp-route-id="@item.LeaveID" class="btn btn-sm btn-success" title="Approve">✅</a>
                                            <a asp-action="Reject" asp-route-id="@item.LeaveID" class="btn btn-sm btn-danger" title="Reject">❌</a>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted fst-italic small">Awaiting Higher Approval</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted small">Completed</span>
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="mt-3">
    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">Back to Dashboard</a>
</div>